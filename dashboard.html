<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="coluna-fixos">
            <h3>ðŸ“Œ Gastos Fixos</h3>
            <div id="listaFixos"></div>
        </aside>

        <div class="conteudo-principal">
            <main class="wide" style="margin: 0; width: 100%;">
                <h2>ðŸ“Š Resumo Geral</h2>
                <div class="filtro-container" style="text-align: center; margin-bottom: 20px;">
                    <label>Filtrar por MÃªs: </label>
                    <select id="filtroMes" onchange="carregarDados()" style="width: auto; display: inline-block;">
                        <option value="todos">Todos os meses</option>
                        <option value="atual" selected>MÃªs Atual</option>
                    </select>
                </div>

                <div class="resumo">
                    <div class="card verde">Ganhos: <span id="totalGanhos">R$ 0</span></div>
                    <div class="card vermelho">Gastos: <span id="totalGastos">R$ 0</span></div>
                    <div class="card azul">Saldo: <span id="saldo">R$ 0</span></div>
                </div>

                <h3>Extrato Detalhado</h3>
                <div id="extrato"></div>
                <a href="index.html" class="btn-voltar">Voltar ao Menu</a>
            </main>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { collection, getDocs, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "login.html"; });

        window.excluirItem = async (id) => {
            if(confirm("Tem certeza que deseja excluir?")) {
                await deleteDoc(doc(db, "transacoes", id));
                carregarDados();
            }
        };

        async function carregarDados() {
            const q = query(collection(db, "transacoes"), orderBy("dataOcorrencia", "desc"));
            const querySnapshot = await getDocs(q);
            const filtro = document.getElementById('filtroMes').value;
            const hoje = new Date();
            
            let tGanhos = 0, tGastos = 0, htmlExtrato = "", htmlFixos = "";

            querySnapshot.forEach((documento) => {
                const d = documento.data();
                const id = documento.id;
                const dataTransacao = new Date(d.dataOcorrencia + "T00:00:00");

                if (filtro === "atual" && (dataTransacao.getMonth() !== hoje.getMonth() || dataTransacao.getFullYear() !== hoje.getFullYear())) return;

                if(d.tipo === 'ganho') tGanhos += d.valor;
                else tGastos += d.valor;

                // Alimenta a lista de fixos lateral
                if(d.fixo) {
                    htmlFixos += `<div class="item-fixo"><span>${d.descricao}</span><strong>R$ ${d.valor.toFixed(2)}</strong></div>`;
                }

                htmlExtrato += `
                    <div class="item-extrato ${d.tipo}">
                        <div class="info">
                            <strong>${d.descricao}</strong>
                            <span>${d.categoria || 'Geral'} | ${d.local || 'N/A'}</span>
                            <small>${d.dataOcorrencia}</small>
                        </div>
                        <div class="valor">
                            R$ ${d.valor.toFixed(2)}<br>
                            <button class="btn-excluir" onclick="excluirItem('${id}')">Excluir</button>
                        </div>
                    </div>`;
            });

            document.getElementById('totalGanhos').innerText = `R$ ${tGanhos.toFixed(2)}`;
            document.getElementById('totalGastos').innerText = `R$ ${tGastos.toFixed(2)}`;
            document.getElementById('saldo').innerText = `R$ ${(tGanhos - tGastos).toFixed(2)}`;
            document.getElementById('listaFixos').innerHTML = htmlFixos || "<p style='color:#999; font-size:0.8rem;'>Nenhum fixo este mÃªs.</p>";
            document.getElementById('extrato').innerHTML = htmlExtrato;
        }

        window.carregarDados = carregarDados;
        carregarDados();
    </script>
</body>
</html>
